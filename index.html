<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 1200px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .input-section {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        #userInput {
            flex: 1;
            min-width: 300px;
            padding: 15px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            outline: none;
        }

        #userInput:focus {
            border-color: #667eea;
        }

        #generateBtn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            white-space: nowrap;
        }

        #generateBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        #generateBtn:active {
            transform: translateY(0);
        }

        #generateBtn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .canvas-section {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        #canvas {
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 100%;
            height: auto;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
            color: #666;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #c33;
            display: none;
        }

        .error.show {
            display: block;
        }

        .success {
            background: #efe;
            color: #363;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #363;
            display: none;
        }

        .success.show {
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            h1 {
                font-size: 2rem;
            }

            .input-section {
                flex-direction: column;
            }

            #userInput {
                min-width: auto;
            }

            #canvas {
                width: 100%;
                max-width: 500px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎨 Canvas Generator</h1>
        
        <div class="input-section">
            <input 
                type="text" 
                id="userInput" 
                placeholder="예: 제주도 여행을 홍보하는 밝고 경쾌한 포스터를 만들어줘"
                maxlength="200"
            >
            <button id="generateBtn">생성하기</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            Canvas를 생성하고 있습니다... 잠시만 기다려주세요.
        </div>

        <div class="error" id="error"></div>
        <div class="success" id="success"></div>

        <div class="canvas-section">
            <canvas id="canvas" width="1080" height="1080"></canvas>
        </div>
    </div>

    <script>
        // DOM 요소들
        const userInput = document.getElementById('userInput');
        const generateBtn = document.getElementById('generateBtn');
        const canvas = document.getElementById('canvas');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const success = document.getElementById('success');

        // API 서버 URL (포트 8001로 변경)
        const API_URL = 'http://localhost:8001';

        // 초기 Canvas 설정
        function initCanvas() {
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 안내 텍스트
            ctx.fillStyle = '#6c757d';
            ctx.font = '24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('위의 입력창에 문구를 입력하고 "생성하기" 버튼을 클릭하세요', canvas.width / 2, canvas.height / 2);
        }

        // 에러 메시지 표시
        function showError(message) {
            error.textContent = message;
            error.classList.add('show');
            success.classList.remove('show');
        }

        // 성공 메시지 표시
        function showSuccess(message) {
            success.textContent = message;
            success.classList.add('show');
            error.classList.remove('show');
        }

        // 메시지 숨기기
        function hideMessages() {
            error.classList.remove('show');
            success.classList.remove('show');
        }

        // 로딩 상태 관리
        function setLoading(isLoading) {
            if (isLoading) {
                loading.classList.add('show');
                generateBtn.disabled = true;
                generateBtn.textContent = '생성 중...';
            } else {
                loading.classList.remove('show');
                generateBtn.disabled = false;
                generateBtn.textContent = '생성하기';
            }
        }

        // Canvas 코드 실행
        function executeCanvasCode(code) {
            try {
                // 기존 Canvas 내용 지우기
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // 코드 검증 및 정리
                const cleanedCode = cleanCanvasCode(code);
                
                // 코드가 비어있는지 확인
                if (!cleanedCode || cleanedCode.trim() === '') {
                    throw new Error('생성된 코드가 비어있습니다.');
                }
                
                // 기본 Canvas 설정 추가 (중복 선언 방지)
                const finalCode = `
                    const ctx = canvas.getContext('2d');
                    try {
                        ${cleanedCode}
                    } catch (err) {
                        console.error('Canvas drawing error:', err);
                        // 기본 Canvas 그리기로 대체
                        ctx.fillStyle = '#87CEEB';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#003366';
                        ctx.font = '40px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('Canvas 생성 중 오류가 발생했습니다', canvas.width / 2, canvas.height / 2);
                    }
                `;
                
                // 안전한 코드 실행을 위한 함수 생성
                const safeExecute = new Function('canvas', finalCode);
                safeExecute(canvas);
                
                showSuccess('Canvas가 성공적으로 생성되었습니다!');
            } catch (err) {
                console.error('Canvas 코드 실행 오류:', err);
                console.error('원본 코드:', code);
                showError('Canvas 코드 실행 중 오류가 발생했습니다: ' + err.message);
            }
        }

        // Canvas 코드 정리 함수
        function cleanCanvasCode(code) {
            try {
                // 한글 주석 제거
                let cleaned = code.replace(/\/\/.*[가-힣].*/g, '');
                
                // 한글이 포함된 문자열을 안전하게 처리
                cleaned = cleaned.replace(/(['"])([^'"]*[가-힣][^'"]*)\1/g, function(match, quote, content) {
                    // 문자열 내의 한글을 유지하되, 문자열 외부의 한글은 제거
                    return quote + content + quote;
                });
                
                // 코드 블록에서 한글 텍스트가 식별자로 사용되는 경우 처리
                cleaned = cleaned.replace(/([a-zA-Z_$][a-zA-Z0-9_$]*)\s*=\s*['"]([^'"]*[가-힣][^'"]*)['"]/g, function(match, varName, content) {
                    return varName + ' = "' + content + '"';
                });
                
                // AI가 생성한 코드의 일반적인 문제들 수정
                cleaned = cleaned.replace(/document\.body\.appendChild\(canvas\)/g, '');
                
                // 모든 getElementById 호출을 canvas로 통일 (중복 선언 제거 전에 실행)
                cleaned = cleaned.replace(/document\.getElementById\(['"][^'"]*['"]\)/g, 'canvas');
                
                // canvas 생성 코드 제거 (이미 HTML에 존재)
                cleaned = cleaned.replace(/const\s+canvas\s*=\s*document\.createElement\(['"]canvas['"]\);/g, '');
                cleaned = cleaned.replace(/let\s+canvas\s*=\s*document\.createElement\(['"]canvas['"]\);/g, '');
                cleaned = cleaned.replace(/var\s+canvas\s*=\s*document\.createElement\(['"]canvas['"]\);/g, '');
                
                // document.createElement('canvas') 자체를 제거
                cleaned = cleaned.replace(/document\.createElement\(['"]canvas['"]\)/g, 'canvas');
                
                // ctx.save()와 ctx.restore() 올바르게 처리
                cleaned = cleaned.replace(/ctx\.save\(\)/g, 'ctx.save();');
                cleaned = cleaned.replace(/ctx\.restore\(\)/g, 'ctx.restore();');
                
                // canvas 크기 설정 제거 (이미 설정되어 있음)
                cleaned = cleaned.replace(/canvas\.width\s*=\s*1080;/g, '');
                cleaned = cleaned.replace(/canvas\.height\s*=\s*1080;/g, '');
                
                // 중복 선언 제거 (이미 전역에서 선언됨)
                cleaned = cleaned.replace(/const\s+canvas\s*=\s*document\.getElementById\(['"]canvas['"]\);/g, '');
                cleaned = cleaned.replace(/const\s+ctx\s*=\s*canvas\.getContext\(['"]2d['"]\);/g, '');
                cleaned = cleaned.replace(/let\s+canvas\s*=\s*document\.getElementById\(['"]canvas['"]\);/g, '');
                cleaned = cleaned.replace(/let\s+ctx\s*=\s*canvas\.getContext\(['"]2d['"]\);/g, '');
                cleaned = cleaned.replace(/var\s+canvas\s*=\s*document\.getElementById\(['"]canvas['"]\);/g, '');
                cleaned = cleaned.replace(/var\s+ctx\s*=\s*canvas\.getContext\(['"]2d['"]\);/g, '');
                
                // 더 포괄적인 중복 선언 제거 (공백과 줄바꿈 고려)
                cleaned = cleaned.replace(/const\s+canvas\s*=\s*document\.getElementById\(['"]canvas['"]\)\s*;?\s*/g, '');
                cleaned = cleaned.replace(/const\s+ctx\s*=\s*canvas\.getContext\(['"]2d['"]\)\s*;?\s*/g, '');
                cleaned = cleaned.replace(/let\s+canvas\s*=\s*document\.getElementById\(['"]canvas['"]\)\s*;?\s*/g, '');
                cleaned = cleaned.replace(/let\s+ctx\s*=\s*canvas\.getContext\(['"]2d['"]\)\s*;?\s*/g, '');
                cleaned = cleaned.replace(/var\s+canvas\s*=\s*document\.getElementById\(['"]canvas['"]\)\s*;?\s*/g, '');
                cleaned = cleaned.replace(/var\s+ctx\s*=\s*canvas\.getContext\(['"]2d['"]\)\s*;?\s*/g, '');
                
                // 줄바꿈으로 구분된 경우도 처리
                cleaned = cleaned.replace(/const\s+canvas\s*=\s*document\.getElementById\(['"]canvas['"]\)\s*;?\s*\n/g, '');
                cleaned = cleaned.replace(/const\s+ctx\s*=\s*canvas\.getContext\(['"]2d['"]\)\s*;?\s*\n/g, '');
                cleaned = cleaned.replace(/let\s+canvas\s*=\s*document\.getElementById\(['"]canvas['"]\)\s*;?\s*\n/g, '');
                cleaned = cleaned.replace(/let\s+ctx\s*=\s*canvas\.getContext\(['"]2d['"]\)\s*;?\s*\n/g, '');
                cleaned = cleaned.replace(/var\s+canvas\s*=\s*document\.getElementById\(['"]canvas['"]\)\s*;?\s*\n/g, '');
                cleaned = cleaned.replace(/var\s+ctx\s*=\s*canvas\.getContext\(['"]2d['"]\)\s*;?\s*\n/g, '');
                
                // 이미지 로딩 부분을 안전하게 처리
                cleaned = cleaned.replace(/new Image\(\)/g, 'null');
                cleaned = cleaned.replace(/img\.src\s*=\s*[^;]+;/g, '');
                cleaned = cleaned.replace(/img\.onload\s*=\s*\(\)\s*=>\s*\{[^}]*\}/g, '');
                
                // forEach 루프를 단순한 도형 그리기로 대체
                cleaned = cleaned.replace(/circleImages\.forEach\([^}]*\}/g, `
                    // Draw simple circles instead of images
                    ctx.fillStyle = '#FF6B6B';
                    ctx.beginPath();
                    ctx.arc(canvas.width / 2 - 150, 750, 80, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#4ECDC4';
                    ctx.beginPath();
                    ctx.arc(canvas.width / 2, 750, 80, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#45B7D1';
                    ctx.beginPath();
                    ctx.arc(canvas.width / 2 + 150, 750, 80, 0, Math.PI * 2);
                    ctx.fill();
                `);
                
                cleaned = cleaned.replace(/seagullImages\.forEach\([^}]*\}/g, `
                    // Draw simple seagull shapes
                    ctx.fillStyle = '#FFFFFF';
                    ctx.beginPath();
                    ctx.arc(150, 75, 20, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(350, 75, 20, 0, Math.PI * 2);
                    ctx.fill();
                `);
                
                // 문제가 될 수 있는 코드 패턴들 제거
                cleaned = cleaned.replace(/ctx\.stroke\(\)/g, '');
                cleaned = cleaned.replace(/ctx\.moveTo\([^)]*\)/g, '');
                cleaned = cleaned.replace(/ctx\.lineTo\([^)]*\)/g, '');
                
                // 불필요한 공백 제거
                cleaned = cleaned.replace(/\s+/g, ' ').trim();
                
                // 코드가 유효한지 확인
                try {
                    new Function('canvas', cleaned);
                } catch (syntaxError) {
                    console.warn('코드 구문 오류 감지, 추가 정리 시도:', syntaxError.message);
                    // 추가 정리: 문제가 될 수 있는 한글 텍스트 제거
                    cleaned = cleaned.replace(/[가-힣]+(?![^'"]*['"])/g, '');
                    
                    // 추가 정리: 문제가 될 수 있는 코드 패턴 제거
                    cleaned = cleaned.replace(/ctx\.restore\(\);/g, '');
                    cleaned = cleaned.replace(/ctx\.save\(\);/g, '');
                    cleaned = cleaned.replace(/ctx\.stroke\(\);/g, '');
                    cleaned = cleaned.replace(/ctx\.moveTo\([^)]*\);/g, '');
                    cleaned = cleaned.replace(/ctx\.lineTo\([^)]*\);/g, '');
                    
                    // 최종 검증
                    try {
                        new Function('canvas', cleaned);
                    } catch (finalError) {
                        console.warn('최종 정리 후에도 오류, 기본 코드 사용:', finalError.message);
                        // 기본 Canvas 코드로 대체
                        cleaned = `
                            ctx.fillStyle = '#87CEEB';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            ctx.fillStyle = '#003366';
                            ctx.font = '40px Arial';
                            ctx.textAlign = 'center';
                            ctx.fillText('Canvas 생성 중 오류가 발생했습니다', canvas.width / 2, canvas.height / 2);
                        `;
                    }
                }
                
                // 최종 안전성 검사
                if (!cleaned.includes('ctx.fillStyle') || !cleaned.includes('ctx.fillRect')) {
                    console.warn('필수 Canvas 코드가 없음, 기본 코드로 대체');
                    cleaned = `
                        ctx.fillStyle = '#87CEEB';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#003366';
                        ctx.font = '40px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('Canvas 생성 중 오류가 발생했습니다', canvas.width / 2, canvas.height / 2);
                    `;
                }
                
                console.log('정리된 Canvas 코드:', cleaned);
                return cleaned;
            } catch (err) {
                console.error('코드 정리 중 오류:', err);
                // 기본적인 정리만 수행
                return code.replace(/[가-힣]+(?![^'"]*['"])/g, '').trim();
            }
        }

        // API 호출
        async function generateCanvas() {
            const inputText = userInput.value.trim();
            
            if (!inputText) {
                showError('문구를 입력해주세요.');
                return;
            }

            hideMessages();
            setLoading(true);

            try {
                const response = await fetch(`${API_URL}/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_input: inputText
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    executeCanvasCode(data.canvas_code);
                } else {
                    showError(data.message || 'Canvas 생성에 실패했습니다.');
                }
            } catch (err) {
                console.error('API 호출 오류:', err);
                showError('서버 연결에 실패했습니다. 서버가 실행 중인지 확인해주세요.');
            } finally {
                setLoading(false);
            }
        }

        // 이벤트 리스너 등록
        generateBtn.addEventListener('click', generateCanvas);
        
        // Enter 키로도 생성 가능
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !generateBtn.disabled) {
                generateCanvas();
            }
        });

        // 입력 필드 포커스 시 메시지 숨기기
        userInput.addEventListener('focus', hideMessages);

        // 초기화
        initCanvas();

        // 서버 상태 확인 (선택사항)
        async function checkServerHealth() {
            try {
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();
                console.log('서버 상태:', data);
            } catch (err) {
                console.warn('서버 상태 확인 실패:', err);
            }
        }

        // 페이지 로드 시 서버 상태 확인
        checkServerHealth();
    </script>
</body>
</html>
