openapi: 3.0.3
info:
  title: StayPost API
  description: |
    StayPost는 감정 기반 펜션/숙박업소 SNS 콘텐츠 생성 플랫폼입니다.
    이 API는 이미지 분석, 캡션 생성, 메타데이터 생성 등의 기능을 제공합니다.
  version: 1.0.0
  contact:
    name: StayPost Team
    email: support@staypost.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://staypost.onrender.com
    description: Production server
  - url: http://localhost:5001
    description: Development server
  - url: https://{project}.supabase.co/functions/v1
    description: Supabase Edge Functions
    variables:
      project:
        default: your-project
        description: Your Supabase project ID

security:
  - BearerAuth: []

paths:
  /api/health:
    get:
      summary: Health check
      description: 서버 상태를 확인하는 간단한 헬스 체크 엔드포인트
      tags:
        - Health
      responses:
        '200':
          description: 서버가 정상 작동 중
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "OK"
                  timestamp:
                    type: string
                    format: date-time
                    example: "2025-01-14T12:00:00Z"
        '500':
          description: 서버 내부 오류
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/caption:
    post:
      summary: 이미지 캡션 생성
      description: 이미지를 분석하여 SNS용 캡션을 생성합니다.
      tags:
        - Caption
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                images:
                  type: array
                  items:
                    type: string
                    format: binary
                  description: 분석할 이미지 파일들
              required:
                - images
      responses:
        '200':
          description: 캡션 생성 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  captions:
                    type: array
                    items:
                      type: string
                    example:
                      - "A cozy morning at the guesthouse ☕️"
                      - "Golden hour vibes with stunning architecture ✨"
                      - "Perfect blend of comfort and elegance 🏡"
        '400':
          description: 파일이 제공되지 않음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: 캡션 생성 실패
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/relight:
    post:
      summary: 이미지 리라이팅
      description: ClipDrop API를 사용하여 이미지의 조명을 변경합니다.
      tags:
        - Image
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                image_file:
                  type: string
                  format: binary
                  description: 처리할 이미지 파일
                prompt:
                  type: string
                  description: 조명 변경 프롬프트
                  example: "warm sunset lighting"
              required:
                - image_file
                - prompt
      responses:
        '200':
          description: 이미지 리라이팅 성공
          content:
            image/jpeg:
              schema:
                type: string
                format: binary
        '400':
          description: 파일 또는 프롬프트 누락
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: ClipDrop API 오류
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /functions/v1/check-slug-availability:
    post:
      summary: 슬러그 사용 가능성 확인
      description: 스토어 슬러그의 사용 가능성을 확인합니다.
      tags:
        - Store
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                slug:
                  type: string
                  description: 확인할 슬러그
                  example: "my-store-name"
              required:
                - slug
      responses:
        '200':
          description: 슬러그 확인 성공
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      available:
                        type: boolean
                        example: true
                  - type: object
                    properties:
                      available:
                        type: boolean
                        example: false
                      suggestedSlug:
                        type: string
                        example: "my-store-name-1"
        '400':
          description: 유효하지 않은 슬러그
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '405':
          description: 허용되지 않는 HTTP 메서드
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: 데이터베이스 오류
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /functions/v1/create-store:
    post:
      summary: 스토어 생성
      description: 새로운 스토어 프로필을 생성합니다.
      tags:
        - Store
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                storeName:
                  type: string
                  description: 스토어 이름
                  example: "My Beautiful Guesthouse"
                slug:
                  type: string
                  description: 스토어 슬러그
                  example: "my-beautiful-guesthouse"
              required:
                - storeName
                - slug
      responses:
        '200':
          description: 스토어 생성 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  store:
                    $ref: '#/components/schemas/Store'
        '400':
          description: 유효하지 않은 입력값
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '405':
          description: 허용되지 않는 HTTP 메서드
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: 슬러그 중복
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: 서버 내부 오류
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /functions/v1/generate-caption:
    post:
      summary: 감정 기반 캡션 생성
      description: 감정과 템플릿을 기반으로 SNS 캡션을 생성합니다.
      tags:
        - Caption
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                emotion:
                  type: string
                  description: 선택된 감정
                  enum: ["설렘", "평온", "즐거움", "로맨틱", "힐링"]
                  example: "설렘"
                templateId:
                  type: string
                  description: 템플릿 ID
                  example: "default_universal"
                storeName:
                  type: string
                  description: 스토어 이름
                  example: "My Guesthouse"
                placeDesc:
                  type: string
                  description: 장소 설명 (선택사항)
                  example: "아늑한, 따뜻한, 편안한 카페 분위기"
              required:
                - emotion
                - templateId
                - storeName
      responses:
        '200':
          description: 캡션 생성 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  hook:
                    type: string
                    description: 매력적인 첫 문장
                    example: "햇살이 머문 오후"
                  caption:
                    type: string
                    description: 본문 캡션
                    example: "통유리창으로 들어오는 빛, 오늘의 속도를 잠시 늦춰보세요."
                  hashtags:
                    type: array
                    items:
                      type: string
                    example: ["감성숙소", "스테이포스트", "여행기록"]
        '422':
          description: 유효성 검사 오류
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '500':
          description: OpenAI 키 누락 또는 내부 오류
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /functions/v1/generate-image-meta:
    post:
      summary: 이미지 메타데이터 생성
      description: 이미지를 분석하여 마케팅용 메타데이터를 생성합니다.
      tags:
        - Image
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                imageBase64:
                  type: string
                  description: Base64로 인코딩된 이미지 데이터
                  example: "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ..."
              required:
                - imageBase64
      responses:
        '200':
          description: 메타데이터 생성 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  main_features:
                    type: array
                    items:
                      type: string
                    description: 주요 특징들
                    example: ["바다", "수영장", "노을", "산", "정원"]
                  view_type:
                    type: string
                    description: 뷰 타입
                    example: "오션뷰"
                  emotions:
                    type: array
                    items:
                      type: string
                    description: 감정적 분위기
                    example: ["감성 힐링", "럭셔리함", "여유로움"]
                  hashtags:
                    type: array
                    items:
                      type: string
                    description: 추천 해시태그
                    example: ["#제주도펜션", "#오션뷰숙소", "#풀빌라추천"]
        '401':
          description: 인증 실패
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '400':
          description: 이미지 데이터 누락
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: OpenAI API 오류 또는 메타데이터 생성 실패
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Supabase JWT 토큰

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          description: 에러 코드
          example: "VALIDATION_ERROR"
        message:
          type: string
          description: 에러 메시지
          example: "Invalid input data"
        details:
          type: object
          description: 상세 에러 정보

    ValidationError:
      type: object
      properties:
        error:
          type: string
          example: "VALIDATION_ERROR"
        details:
          type: object
          properties:
            fieldErrors:
              type: object
              additionalProperties:
                type: array
                items:
                  type: string
              example:
                emotion: ["Emotion is required"]

    Store:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: 스토어 ID
          example: "123e4567-e89b-12d3-a456-426614174000"
        store_name:
          type: string
          description: 스토어 이름
          example: "My Beautiful Guesthouse"
        slug:
          type: string
          description: 스토어 슬러그
          example: "my-beautiful-guesthouse"
        created_at:
          type: string
          format: date-time
          description: 생성 시간
          example: "2024-01-01T00:00:00.000Z"

    EmotionCard:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: 감정 카드 ID
        image_url:
          type: string
          description: 이미지 URL
        caption:
          type: string
          description: 캡션
        emotion:
          type: string
          enum: ["설렘", "평온", "즐거움", "로맨틱", "힐링"]
          description: 선택된 감정
        template_id:
          type: string
          description: 템플릿 ID
        store_slug:
          type: string
          description: 스토어 슬러그
        seo_title:
          type: string
          description: SEO 제목
        seo_keywords:
          type: array
          items:
            type: string
          description: SEO 키워드
        seo_hashtags:
          type: array
          items:
            type: string
          description: SEO 해시태그
        created_at:
          type: string
          format: date-time
          description: 생성 시간

    Reservation:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: 예약 ID
        store_slug:
          type: string
          description: 스토어 슬러그
        date:
          type: string
          format: date
          description: 예약 날짜
        time:
          type: string
          format: time
          description: 예약 시간
        person_count:
          type: integer
          minimum: 1
          maximum: 20
          description: 인원 수
        name:
          type: string
          description: 예약자 이름
        phone:
          type: string
          description: 연락처
        request:
          type: string
          description: 특별 요청사항
        created_at:
          type: string
          format: date-time
          description: 예약 생성 시간

tags:
  - name: Health
    description: 헬스 체크 관련 엔드포인트
  - name: Caption
    description: 캡션 생성 관련 엔드포인트
  - name: Image
    description: 이미지 처리 관련 엔드포인트
  - name: Store
    description: 스토어 관리 관련 엔드포인트
  - name: Auth
    description: 인증 관련 엔드포인트
